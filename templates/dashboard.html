<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Signal Management</title>
    <meta name="description"
        content="Real-time smart traffic signal management dashboard with adaptive timing, live countdown, and analytics.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .bg-mesh {
            position: fixed;
            inset: 0;
            z-index: -1;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(56, 189, 248, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(16, 185, 129, 0.06) 0%, transparent 50%),
                #0f172a;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
        }

        .glass-hover {
            transition: all 0.3s ease;
        }

        .glass-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .signal-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-block;
            transition: all 0.4s ease;
        }

        .signal-dot.active {
            box-shadow: 0 0 14px 4px currentColor;
        }

        .signal-dot.dim {
            opacity: 0.15;
        }

        .phase-green {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .phase-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .phase-red {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .density-low {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .density-medium {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .density-high {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .countdown-ring {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .countdown-ring svg {
            transform: rotate(-90deg);
        }

        .countdown-ring .value {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
        }

        @keyframes emergencyPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
            }
        }

        .emergency-active {
            animation: emergencyPulse 1.5s ease-in-out infinite;
            border-color: rgba(239, 68, 68, 0.5) !important;
        }

        #map {
            height: 380px;
            border-radius: 12px;
            z-index: 1;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 3px;
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transform: translateX(120%);
            transition: transform 0.4s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(0);
        }

        @keyframes userPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.6;
            }

            50% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Congestion alert */
        @keyframes alertSlide {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .congestion-alert {
            animation: alertSlide 0.4s ease-out;
        }

        /* Efficiency bar */
        .eff-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(148, 163, 184, 0.15);
            overflow: hidden;
        }

        .eff-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden {
            display: none;
        }

        /* Tab system */
        .tab-btn {
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
            border-color: rgba(56, 189, 248, 0.3);
        }
    </style>
</head>

<body>
    <div class="bg-mesh"></div>

    <!-- Toast -->
    <div id="toast" class="toast glass" style="border: 1px solid rgba(16,185,129,0.4); color: #34d399;"></div>

    <!-- Congestion Alert Banner -->
    <div id="congestionAlert"
        class="hidden congestion-alert fixed top-0 left-0 right-0 z-50 px-6 py-3 text-center font-bold text-sm"
        style="background: linear-gradient(135deg, rgba(239,68,68,0.9), rgba(220,38,38,0.9)); color: white;">
        <span id="congestionMsg" class="flex items-center justify-center gap-2"></span>
    </div>

    <!-- Add Signal Modal -->
    <div id="addSignalModal" class="modal-overlay hidden">
        <div class="glass p-8 w-full max-w-md space-y-4">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i data-lucide="plus-circle" style="width:20px;height:20px;" class="text-cyan-400"></i> Add New Signal
            </h3>
            <input id="newSigName" type="text" placeholder="Signal name (e.g. Signal-G)"
                class="w-full px-4 py-2.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
            <input id="newSigLocation" type="text" placeholder="Location (e.g. City Center)"
                class="w-full px-4 py-2.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
            <div class="grid grid-cols-2 gap-3">
                <input id="newSigLat" type="number" step="any" placeholder="Latitude"
                    class="px-4 py-2.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
                <input id="newSigLng" type="number" step="any" placeholder="Longitude"
                    class="px-4 py-2.5 rounded-lg bg-slate-800/80 border border-slate-600/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
            </div>
            <p id="autoFillNote" class="text-xs text-slate-500 hidden">
                <i data-lucide="info" style="width:12px;height:12px;display:inline;"></i>
                Latitude and longitude auto-filled from your location. Adjust as needed.
            </p>
            <button onclick="closeAddModal(); startPlaceMode();"
                class="w-full py-2 rounded-lg text-xs font-bold border border-dashed border-cyan-500/40 text-cyan-400 hover:bg-cyan-500/10 transition-all flex items-center justify-center gap-1.5">
                <i data-lucide="crosshair" style="width:14px;height:14px;"></i> Pick Location on Map
            </button>
            <div class="flex gap-3 pt-2">
                <button onclick="submitAddSignal()"
                    class="flex-1 py-2.5 rounded-lg text-sm font-bold bg-gradient-to-r from-cyan-600 to-blue-600 text-white hover:from-cyan-500 hover:to-blue-500 transition-all flex items-center justify-center gap-1.5">
                    <i data-lucide="check" style="width:16px;height:16px;"></i> Add Signal
                </button>
                <button onclick="closeAddModal()"
                    class="flex-1 py-2.5 rounded-lg text-sm font-bold border border-slate-600 text-slate-300 hover:bg-slate-700/50 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="mainHeader" class="sticky top-0 z-40 glass border-b border-slate-700/50"
        style="backdrop-filter: blur(20px);">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
                    <i data-lucide="traffic-cone" class="text-white" style="width:22px;height:22px;"></i>
                </div>
                <div>
                    <h1
                        class="text-lg font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">
                        Traffic Signal Command</h1>
                    <p class="text-xs text-slate-400">Smart Adaptive Control System</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="liveClock" class="text-sm font-mono text-slate-400"></span>
                <span class="flex items-center gap-1.5 text-xs font-semibold text-emerald-400">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> LIVE
                </span>
                <button onclick="openAddModal()"
                    class="px-3 py-2 text-sm font-semibold rounded-xl border border-slate-600 text-slate-300 hover:bg-slate-700/50 transition-all flex items-center gap-1.5">
                    <i data-lucide="plus" style="width:14px;height:14px;"></i> Add Signal
                </button>
                <button onclick="simulateAll()" id="simBtn"
                    class="px-4 py-2 text-sm font-semibold rounded-xl bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white transition-all hover:scale-105 active:scale-95 flex items-center gap-2">
                    <i data-lucide="shuffle" style="width:14px;height:14px;"></i> Simulate
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">

        <!-- Stats Row -->
        <section id="statsRow" class="grid grid-cols-2 md:grid-cols-5 gap-4"></section>

        <!-- Tabs -->
        <div class="flex gap-2" id="tabBar">
            <button onclick="switchTab('signals')" data-tab="signals"
                class="tab-btn px-4 py-2 rounded-xl text-sm font-semibold border border-slate-600/50 text-slate-400 flex items-center gap-1.5 active">
                <i data-lucide="radio-tower" style="width:14px;height:14px;"></i> Signals
            </button>
            <button onclick="switchTab('analytics')" data-tab="analytics"
                class="tab-btn px-4 py-2 rounded-xl text-sm font-semibold border border-slate-600/50 text-slate-400 flex items-center gap-1.5">
                <i data-lucide="bar-chart-3" style="width:14px;height:14px;"></i> Analytics
            </button>
        </div>

        <!-- SIGNALS TAB -->
        <div id="tab-signals">
            <!-- Signal Cards -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="radio-tower" style="width:20px;height:20px;" class="text-cyan-400"></i> Signal
                        Status
                    </h2>
                    <span id="lastUpdated" class="text-xs text-slate-500"></span>
                </div>
                <div id="signalGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
            </section>

            <!-- Charts + Map -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" style="width:20px;height:20px;" class="text-violet-400"></i>
                        Vehicle Count Trends
                    </h3>
                    <div style="height: 300px;"><canvas id="trendChart"></canvas></div>
                </div>
                <div class="glass p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="map-pin" style="width:20px;height:20px;" class="text-rose-400"></i> Signal
                            Map
                        </h3>
                        <div class="flex items-center gap-2">
                            <span id="locationStatus" class="text-xs text-slate-500 flex items-center gap-1">
                                <i data-lucide="loader" style="width:14px;height:14px;" class="animate-spin"></i>
                                Locating...
                            </span>
                            <button onclick="centerOnUser()" id="locateBtn"
                                class="px-2.5 py-1.5 rounded-lg text-xs font-semibold border border-slate-600/50 text-slate-400 hover:bg-slate-700/50 transition-all flex items-center gap-1 hidden">
                                <i data-lucide="navigation" style="width:12px;height:12px;"></i> Center
                            </button>
                        </div>
                    </div>
                    <div id="map"></div>
                    <p class="text-xs text-slate-500 mt-3 flex items-center gap-1.5">
                        <i data-lucide="move" style="width:12px;height:12px;"></i>
                        <span><b>Drag markers</b> to reposition signals on the map. Positions auto-save.</span>
                    </p>
                </div>
            </section>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="tab-analytics" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Signal Rankings -->
                <div class="glass p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="trophy" style="width:20px;height:20px;" class="text-amber-400"></i> Signal
                        Rankings (by avg. traffic)
                    </h3>
                    <div id="rankingsTable"></div>
                </div>
                <!-- Density Distribution -->
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" style="width:20px;height:20px;" class="text-cyan-400"></i> Density
                        Distribution
                    </h3>
                    <div style="height: 250px;"><canvas id="densityChart"></canvas></div>
                    <div id="densityLegend" class="mt-4 space-y-2"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- System Summary -->
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="activity" style="width:20px;height:20px;" class="text-emerald-400"></i> System
                        Summary
                    </h3>
                    <div id="systemSummary" class="space-y-4"></div>
                </div>
                <!-- Peak Record -->
                <div class="glass p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="flame" style="width:20px;height:20px;" class="text-orange-400"></i> Peak Traffic
                        Record
                    </h3>
                    <div id="peakRecord" class="space-y-4"></div>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center py-6 text-slate-600 text-xs">Smart Traffic Signal Management System &copy; 2026</footer>

    <script>
        // ─── STATE ─────────────────────────────────────────
        let signalsData = [];
        let trendChart = null;
        let densityChart = null;
        let mapInstance = null;
        let mapMarkers = {};
        let userMarker = null;
        let userLocation = null;
        let locationRelocated = false;
        let mapFitted = false;
        const POLL_INTERVAL = 3000;
        const CHART_COLORS = [
            'rgb(56, 189, 248)', 'rgb(168, 85, 247)', 'rgb(52, 211, 153)',
            'rgb(251, 191, 36)', 'rgb(248, 113, 113)', 'rgb(96, 165, 250)',
            'rgb(244, 114, 182)', 'rgb(163, 230, 53)',
        ];

        // Inline SVG icons for dynamic rendering
        const ICONS = {
            car: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>`,
            timer: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>`,
            alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`,
            siren: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 18v-6a5 5 0 1 1 10 0v6"/><path d="M5 21a1 1 0 0 0 1-1v-1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v1a1 1 0 0 0 1 1"/><path d="M1 10h1"/><path d="M22 10h1"/><path d="m3.5 4.5.7.7"/><path d="m19.8 4.5-.7.7"/><path d="M12 2v1"/></svg>`,
            gauge: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>`,
        };

        // ─── HELPERS ───────────────────────────────────────
        function phaseColor(p) { return { green: '#10b981', yellow: '#f59e0b', red: '#ef4444' }[p] || '#64748b'; }
        function densityClass(d) { return { Low: 'density-low', Medium: 'density-medium', High: 'density-high' }[d] || ''; }
        function phaseClass(p) { return { green: 'phase-green', yellow: 'phase-yellow', red: 'phase-red' }[p] || ''; }
        function effColor(e) { return e >= 80 ? '#10b981' : e >= 50 ? '#f59e0b' : '#ef4444'; }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i data-lucide="${isError ? 'x-circle' : 'check-circle'}" style="width:16px;height:16px;"></i> ${msg}`;
            t.style.borderColor = isError ? 'rgba(239,68,68,0.4)' : 'rgba(16,185,129,0.4)';
            t.style.color = isError ? '#f87171' : '#34d399';
            t.classList.add('show');
            lucide.createIcons({ nodes: [t] });
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ─── CLOCK ─────────────────────────────────────────
        setInterval(() => {
            document.getElementById('liveClock').textContent = new Date().toLocaleTimeString();
        }, 1000);
        document.getElementById('liveClock').textContent = new Date().toLocaleTimeString();

        // ─── TABS ──────────────────────────────────────────
        function switchTab(tab) {
            document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('tab-signals').classList.toggle('hidden', tab !== 'signals');
            document.getElementById('tab-analytics').classList.toggle('hidden', tab !== 'analytics');
            if (tab === 'analytics') loadAnalytics();
        }

        // ─── COUNTDOWN RING ────────────────────────────────
        function ringSVG(countdown, maxTime, color) {
            const r = 34, c = 2 * Math.PI * r;
            const pct = Math.max(0, Math.min(1, countdown / maxTime));
            const offset = c * (1 - pct);
            return `<div class="countdown-ring">
        <svg width="80" height="80" viewBox="0 0 80 80">
            <circle cx="40" cy="40" r="${r}" fill="none" stroke="rgba(148,163,184,0.1)" stroke-width="6"/>
            <circle cx="40" cy="40" r="${r}" fill="none" stroke="${color}" stroke-width="6"
                stroke-dasharray="${c}" stroke-dashoffset="${offset}" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"/>
        </svg>
        <div class="value" style="color:${color}">${Math.max(0, countdown)}</div>
    </div>`;
        }

        function signalLights(phase) {
            return ['red', 'yellow', 'green'].map(l => {
                const c = { red: '#ef4444', yellow: '#fbbf24', green: '#10b981' }[l];
                return `<span class="signal-dot ${l === phase ? 'active' : 'dim'}" style="color:${c};background:${c};"></span>`;
            }).join('');
        }

        // ─── CONGESTION ALERT ──────────────────────────────
        function checkCongestion() {
            const highCount = signalsData.filter(s => s.density === 'High').length;
            const el = document.getElementById('congestionAlert');
            const msg = document.getElementById('congestionMsg');
            const header = document.getElementById('mainHeader');
            if (highCount >= 3) {
                msg.innerHTML = `<i data-lucide="alert-triangle" style="width:18px;height:18px;"></i> CONGESTION WARNING: ${highCount} of ${signalsData.length} signals at high density — consider emergency intervention`;
                el.classList.remove('hidden');
                header.style.top = '40px';
                lucide.createIcons({ nodes: [msg] });
            } else {
                el.classList.add('hidden');
                header.style.top = '0';
            }
        }

        // ─── RENDER STATS ──────────────────────────────────
        function renderStats() {
            const total = signalsData.reduce((s, x) => s + x.vehicle_count, 0);
            const avgGreen = signalsData.length ? Math.round(signalsData.reduce((s, x) => s + x.green_time, 0) / signalsData.length) : 0;
            const high = signalsData.filter(x => x.density === 'High').length;
            const emergency = signalsData.filter(x => x.emergency).length;
            const avgEff = signalsData.length ? Math.round(signalsData.reduce((s, x) => s + (x.efficiency || 0), 0) / signalsData.length) : 0;

            const stats = [
                { label: 'Total Vehicles', value: total, icon: ICONS.car, color: 'from-cyan-500 to-blue-600' },
                { label: 'Avg Green Time', value: avgGreen + 's', icon: ICONS.timer, color: 'from-emerald-500 to-teal-600' },
                { label: 'High Density', value: high, icon: ICONS.alert, color: 'from-amber-500 to-orange-600' },
                { label: 'Emergency', value: emergency, icon: ICONS.siren, color: 'from-red-500 to-rose-600' },
                { label: 'Avg Efficiency', value: avgEff + '%', icon: ICONS.gauge, color: 'from-violet-500 to-purple-600' },
            ];

            document.getElementById('statsRow').innerHTML = stats.map(s => `
        <div class="glass glass-hover p-5 flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${s.color} flex items-center justify-center text-white flex-shrink-0">${s.icon}</div>
            <div>
                <div class="text-2xl font-bold text-white">${s.value}</div>
                <div class="text-xs text-slate-400 font-medium">${s.label}</div>
            </div>
        </div>`).join('');
        }

        // ─── RENDER SIGNALS ────────────────────────────────
        function renderSignals() {
            document.getElementById('signalGrid').innerHTML = signalsData.map(sig => {
                const maxT = sig.green_time + 10;
                const color = phaseColor(sig.current_phase);
                const em = sig.emergency;
                const eff = sig.efficiency || 0;
                const ec = effColor(eff);
                return `
        <div class="glass glass-hover p-6 ${em ? 'emergency-active' : ''}">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="radio" class="text-slate-400" style="width:16px;height:16px;"></i> ${sig.name}
                    </h3>
                    <p class="text-xs text-slate-400 flex items-center gap-1 mt-0.5">
                        <i data-lucide="map-pin" style="width:12px;height:12px;"></i> ${sig.location}
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    ${signalLights(sig.current_phase)}
                    <button onclick="deleteSignalById(${sig.id})" class="ml-2 p-1.5 rounded-lg text-slate-500 hover:text-red-400 hover:bg-red-500/10 transition-all" title="Delete signal">
                        <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-6 mb-4">
                ${ringSVG(sig.countdown, maxT, color)}
                <div class="flex-1 space-y-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="px-2.5 py-1 rounded-full text-xs font-bold ${phaseClass(sig.current_phase)} uppercase">${sig.current_phase}</span>
                        <span class="px-2.5 py-1 rounded-full text-xs font-bold ${densityClass(sig.density)}">${sig.density}</span>
                        ${em ? '<span class="px-2.5 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/30 flex items-center gap-1"><i data-lucide="siren" style="width:12px;height:12px;"></i> EMERGENCY</span>' : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <span class="text-slate-400 flex items-center gap-1"><i data-lucide="car" style="width:14px;height:14px;"></i> Vehicles</span>
                        <span class="text-white font-semibold">${sig.vehicle_count}</span>
                        <span class="text-slate-400 flex items-center gap-1"><i data-lucide="timer" style="width:14px;height:14px;"></i> Green Time</span>
                        <span class="text-white font-semibold">${sig.green_time}s</span>
                    </div>
                    <!-- Efficiency bar -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500 flex items-center gap-1"><i data-lucide="gauge" style="width:12px;height:12px;"></i> Efficiency</span>
                            <span style="color:${ec}" class="font-bold">${eff}%</span>
                        </div>
                        <div class="eff-bar"><div class="eff-fill" style="width:${eff}%;background:${ec};"></div></div>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700/50 pt-4 space-y-3">
                <div class="flex gap-2">
                    <input type="number" id="vc-${sig.id}" placeholder="Vehicle count" min="0" max="200"
                        class="flex-1 px-3 py-2 rounded-lg bg-slate-800/80 border border-slate-600/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
                    <button onclick="overrideSignal(${sig.id})"
                        class="px-4 py-2 rounded-lg text-xs font-bold bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 hover:bg-cyan-600/30 transition-all flex items-center gap-1">
                        <i data-lucide="sliders-horizontal" style="width:14px;height:14px;"></i> Override
                    </button>
                </div>
                <button onclick="toggleEmergency(${sig.id}, ${em ? 'false' : 'true'})"
                    class="w-full py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1.5
                        ${em ? 'bg-red-500/20 text-red-400 border border-red-500/30 hover:bg-red-500/30' : 'bg-slate-700/50 text-slate-400 border border-slate-600/30 hover:bg-slate-700'}">
                    <i data-lucide="${em ? 'shield-off' : 'ambulance'}" style="width:14px;height:14px;"></i>
                    ${em ? 'Disable Emergency' : 'Enable Emergency Priority'}
                </button>
            </div>
        </div>`;
            }).join('');
            lucide.createIcons();
        }

        // ─── MAP ───────────────────────────────────────────
        let mapClickMode = null; // null or 'place'

        function initMap() {
            if (mapInstance) return;
            // Default to Coimbatore; will auto-center on signals or user location
            mapInstance = L.map('map', { zoomControl: false }).setView([11.0168, 76.9558], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM & CARTO', maxZoom: 19,
            }).addTo(mapInstance);
            L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);

            // Click-to-place: fill lat/lng into the Add Signal modal
            mapInstance.on('click', function (e) {
                if (mapClickMode === 'place') {
                    document.getElementById('newSigLat').value = e.latlng.lat.toFixed(6);
                    document.getElementById('newSigLng').value = e.latlng.lng.toFixed(6);
                    mapClickMode = null;
                    document.getElementById('map').style.cursor = '';
                    openAddModal();
                    showToast('Location picked — fill in name and submit');
                }
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, {
                    enableHighAccuracy: true, timeout: 10000, maximumAge: 0,
                });
            } else {
                onLocationError();
            }
        }

        function startPlaceMode() {
            mapClickMode = 'place';
            document.getElementById('map').style.cursor = 'crosshair';
            showToast('Click on the map to pick a location for the new signal');
            // Scroll to map
            document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function onLocationFound(pos) {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };

            // Add pulsing blue user marker
            const userIcon = L.divIcon({
                className: '',
                html: `<div style="position:relative;width:20px;height:20px;">
            <div style="position:absolute;inset:-6px;background:rgba(56,189,248,0.2);border-radius:50%;animation:userPulse 2s ease-in-out infinite;"></div>
            <div style="width:20px;height:20px;border-radius:50%;background:#38bdf8;border:3px solid #fff;box-shadow:0 0 12px rgba(56,189,248,0.6);position:relative;z-index:2;"></div>
        </div>`,
                iconSize: [20, 20], iconAnchor: [10, 10],
            });
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                .addTo(mapInstance).bindPopup('<b>Your Location</b>');

            // Center map on user
            mapInstance.setView([userLocation.lat, userLocation.lng], 14);

            // Relocate signals around user (once)
            if (!locationRelocated) {
                locationRelocated = true;
                fetch('/relocate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: userLocation.lat, lng: userLocation.lng }),
                }).then(() => fetchSignals());
            }

            // Update status
            document.getElementById('locationStatus').innerHTML = `<i data-lucide="navigation" style="width:14px;height:14px;" class="text-emerald-400"></i><span class="text-emerald-400">Location found</span>`;
            document.getElementById('locateBtn').classList.remove('hidden');
            lucide.createIcons({ nodes: [document.getElementById('locationStatus')] });

            // Pre-fill add-signal modal
            document.getElementById('newSigLat').value = userLocation.lat.toFixed(4);
            document.getElementById('newSigLng').value = userLocation.lng.toFixed(4);
            document.getElementById('autoFillNote').classList.remove('hidden');
        }

        function onLocationError() {
            document.getElementById('locationStatus').innerHTML = `<i data-lucide="map-pin-off" style="width:14px;height:14px;" class="text-slate-500"></i><span>Location unavailable</span>`;
            lucide.createIcons({ nodes: [document.getElementById('locationStatus')] });
        }

        function centerOnUser() {
            if (userLocation && mapInstance) {
                mapInstance.setView([userLocation.lat, userLocation.lng], 14, { animate: true });
            }
        }

        function updateMapMarkers() {
            // Clean up old markers for deleted signals
            Object.keys(mapMarkers).forEach(id => {
                if (!signalsData.find(s => s.id == id)) {
                    mapInstance.removeLayer(mapMarkers[id]);
                    delete mapMarkers[id];
                }
            });
            signalsData.forEach(sig => {
                const color = phaseColor(sig.current_phase);
                const icon = L.divIcon({
                    className: '',
                    html: `<div style="width:32px;height:32px;border-radius:50%;background:${color};border:3px solid rgba(255,255,255,0.9);box-shadow:0 0 12px ${color};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;cursor:grab;">${sig.vehicle_count}</div>`,
                    iconSize: [32, 32], iconAnchor: [16, 16],
                });
                if (mapMarkers[sig.id]) {
                    mapMarkers[sig.id].setLatLng([sig.lat, sig.lng]).setIcon(icon);
                    mapMarkers[sig.id].setPopupContent(`<div style="font-family:Inter,sans-serif;color:#333;"><b>${sig.name}</b><br>${sig.location}<br>Vehicles: ${sig.vehicle_count} &bull; ${sig.density}<br><i style='font-size:11px;color:#666;'>Drag to reposition</i></div>`);
                } else {
                    // Create draggable marker
                    const marker = L.marker([sig.lat, sig.lng], { icon, draggable: true })
                        .addTo(mapInstance)
                        .bindPopup(`<div style="font-family:Inter,sans-serif;color:#333;"><b>${sig.name}</b><br>${sig.location}<br><i style='font-size:11px;color:#666;'>Drag to reposition</i></div>`);

                    // Save new position on drag end
                    marker.on('dragend', function (e) {
                        const pos = e.target.getLatLng();
                        fetch('/move-signal', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ signal_id: sig.id, lat: pos.lat, lng: pos.lng }),
                        }).then(r => r.json()).then(() => {
                            showToast(`${sig.name} moved to new position`);
                        }).catch(() => showToast('Failed to save position', true));
                    });

                    mapMarkers[sig.id] = marker;
                }
            });

            // Auto-fit map to show all signals on first load
            if (!mapFitted && signalsData.length > 0 && !userLocation) {
                const bounds = L.latLngBounds(signalsData.map(s => [s.lat, s.lng]));
                mapInstance.fitBounds(bounds, { padding: [30, 30], maxZoom: 14 });
                mapFitted = true;
            }
        }

        // ─── TREND CHART ───────────────────────────────────
        async function loadTrendChart() {
            if (!signalsData.length) return;
            const datasets = [];
            for (let i = 0; i < signalsData.length; i++) {
                try {
                    const res = await fetch(`/history/${signalsData[i].id}?limit=20`);
                    const hist = await res.json();
                    datasets.push({
                        label: signalsData[i].name,
                        data: hist.map(h => h.vehicle_count),
                        borderColor: CHART_COLORS[i % CHART_COLORS.length],
                        backgroundColor: CHART_COLORS[i % CHART_COLORS.length].replace('rgb', 'rgba').replace(')', ',0.1)'),
                        fill: true, tension: 0.4, borderWidth: 2, pointRadius: 3, pointHoverRadius: 6,
                    });
                } catch (e) { }
            }
            const maxLen = Math.max(...datasets.map(d => d.data.length), 0);
            const labels = Array.from({ length: maxLen }, (_, i) => i + 1);
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 } } } },
                    scales: {
                        x: { ticks: { color: '#475569' }, grid: { color: 'rgba(51,65,85,0.3)' } },
                        y: { ticks: { color: '#475569' }, grid: { color: 'rgba(51,65,85,0.3)' }, beginAtZero: true, title: { display: true, text: 'Vehicle Count', color: '#64748b' } },
                    },
                },
            });
        }

        // ─── ANALYTICS ─────────────────────────────────────
        async function loadAnalytics() {
            try {
                const res = await fetch('/analytics');
                const data = await res.json();

                // Rankings table
                const rankings = data.signal_rankings || [];
                document.getElementById('rankingsTable').innerHTML = `
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead><tr class="text-left text-slate-500 border-b border-slate-700/50">
                        <th class="pb-3 font-medium">#</th><th class="pb-3 font-medium">Signal</th>
                        <th class="pb-3 font-medium">Avg</th><th class="pb-3 font-medium">Peak</th>
                        <th class="pb-3 font-medium">Min</th><th class="pb-3 font-medium">Snapshots</th>
                    </tr></thead>
                    <tbody>${rankings.map((r, i) => `
                        <tr class="border-b border-slate-700/30 hover:bg-slate-700/20 transition-colors">
                            <td class="py-3 font-bold ${i === 0 ? 'text-amber-400' : i === 1 ? 'text-slate-300' : i === 2 ? 'text-amber-600' : 'text-slate-500'}">${i + 1}</td>
                            <td class="py-3 text-white font-semibold">${r.name}</td>
                            <td class="py-3">${Math.round(r.avg_vehicles)}</td>
                            <td class="py-3 text-red-400 font-semibold">${r.peak_vehicles}</td>
                            <td class="py-3 text-emerald-400">${r.min_vehicles}</td>
                            <td class="py-3 text-slate-400">${r.total_snapshots}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            </div>`;

                // Density donut chart
                const dist = data.density_distribution || {};
                const dLabels = Object.keys(dist);
                const dValues = Object.values(dist);
                const dColors = dLabels.map(d => ({ Low: '#10b981', Medium: '#f59e0b', High: '#ef4444' }[d] || '#64748b'));
                const ctx2 = document.getElementById('densityChart').getContext('2d');
                if (densityChart) densityChart.destroy();
                densityChart = new Chart(ctx2, {
                    type: 'doughnut', data: { labels: dLabels, datasets: [{ data: dValues, backgroundColor: dColors, borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '65%',
                        plugins: { legend: { display: false } }
                    },
                });
                document.getElementById('densityLegend').innerHTML = dLabels.map((l, i) => `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background:${dColors[i]}"></span>
                    <span class="text-sm text-slate-300">${l}</span>
                </div>
                <span class="text-sm font-bold text-white">${dValues[i]}</span>
            </div>`).join('');

                // System summary
                document.getElementById('systemSummary').innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="glass p-4 text-center"><div class="text-2xl font-bold text-white">${data.total_snapshots}</div><div class="text-xs text-slate-400 mt-1">Total Snapshots</div></div>
                <div class="glass p-4 text-center"><div class="text-2xl font-bold text-white">${data.average_vehicles}</div><div class="text-xs text-slate-400 mt-1">Avg Vehicles</div></div>
                <div class="glass p-4 text-center"><div class="text-2xl font-bold text-white">${signalsData.length}</div><div class="text-xs text-slate-400 mt-1">Active Signals</div></div>
                <div class="glass p-4 text-center"><div class="text-2xl font-bold text-white">${signalsData.filter(s => s.emergency).length}</div><div class="text-xs text-slate-400 mt-1">In Emergency</div></div>
            </div>`;

                // Peak record
                const peak = data.peak;
                if (peak) {
                    const peakSig = signalsData.find(s => s.id === peak.signal_id);
                    document.getElementById('peakRecord').innerHTML = `
                <div class="glass p-5 text-center">
                    <div class="text-4xl font-bold text-red-400">${peak.vehicle_count}</div>
                    <div class="text-sm text-slate-300 mt-2">vehicles at <span class="text-white font-semibold">${peakSig ? peakSig.name : 'Signal #' + peak.signal_id}</span></div>
                    <div class="text-xs text-slate-500 mt-1">${new Date(peak.timestamp).toLocaleString()}</div>
                </div>`;
                } else {
                    document.getElementById('peakRecord').innerHTML = '<p class="text-slate-500 text-sm">No data yet. Run some simulations first.</p>';
                }
            } catch (e) { console.error('Analytics error', e); }
        }

        // ─── ADD / DELETE SIGNALS ──────────────────────────
        function openAddModal() {
            document.getElementById('addSignalModal').classList.remove('hidden');
            lucide.createIcons({ nodes: [document.getElementById('addSignalModal')] });
        }
        function closeAddModal() { document.getElementById('addSignalModal').classList.add('hidden'); }

        async function submitAddSignal() {
            const name = document.getElementById('newSigName').value.trim();
            const location = document.getElementById('newSigLocation').value.trim();
            const lat = parseFloat(document.getElementById('newSigLat').value);
            const lng = parseFloat(document.getElementById('newSigLng').value);
            if (!name || isNaN(lat) || isNaN(lng)) { showToast('Fill in name, latitude, and longitude', true); return; }

            try {
                await fetch('/add-signal', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, location: location || name, lat, lng }),
                });
                closeAddModal();
                document.getElementById('newSigName').value = '';
                document.getElementById('newSigLocation').value = '';
                await fetchSignals();
                await loadTrendChart();
                showToast(`Signal "${name}" added`);
            } catch (e) { showToast('Failed to add signal', true); }
        }

        async function deleteSignalById(id) {
            if (!confirm('Delete this signal and all its history?')) return;
            try {
                await fetch(`/delete-signal/${id}`, { method: 'DELETE' });
                await fetchSignals();
                await loadTrendChart();
                showToast('Signal deleted');
            } catch (e) { showToast('Failed to delete signal', true); }
        }

        // ─── API CALLS ─────────────────────────────────────
        async function fetchSignals() {
            try {
                const res = await fetch('/signals');
                signalsData = await res.json();
                renderStats();
                renderSignals();
                updateMapMarkers();
                checkCongestion();
                document.getElementById('lastUpdated').textContent = 'Updated ' + new Date().toLocaleTimeString();
            } catch (e) { console.error('Fetch failed', e); }
        }

        async function simulateAll() {
            const btn = document.getElementById('simBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" style="width:14px;height:14px;" class="animate-spin"></i> Working...';
            lucide.createIcons({ nodes: [btn] });
            try {
                await fetch('/simulate');
                await fetchSignals();
                await loadTrendChart();
                showToast('Simulation complete — counts regenerated');
            } catch (e) { showToast('Simulation failed', true); }
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="shuffle" style="width:14px;height:14px;"></i> Simulate';
            lucide.createIcons({ nodes: [btn] });
        }

        async function overrideSignal(id) {
            const input = document.getElementById(`vc-${id}`);
            const vc = parseInt(input.value);
            if (isNaN(vc) || vc < 0) { showToast('Enter a valid vehicle count', true); return; }
            try {
                await fetch('/override', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signal_id: id, vehicle_count: vc })
                });
                await fetchSignals(); await loadTrendChart();
                showToast(`Signal #${id} overridden — ${vc} vehicles`); input.value = '';
            } catch (e) { showToast('Override failed', true); }
        }

        async function toggleEmergency(id, enable) {
            try {
                await fetch('/emergency', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signal_id: id, enable })
                });
                await fetchSignals();
                showToast(enable ? 'Emergency mode ACTIVATED' : 'Emergency mode disabled');
            } catch (e) { showToast('Emergency toggle failed', true); }
        }

        // ─── INIT ──────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            initMap();
            await fetchSignals();
            await loadTrendChart();
            setInterval(fetchSignals, POLL_INTERVAL);
            setInterval(loadTrendChart, 15000);
        });
    </script>
</body>

</html>